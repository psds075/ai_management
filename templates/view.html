<!DOCTYPE html>
<html lang="en">
<title>AIQUB DENTAL SERVICE</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../static/css/imageviewer.css" type="text/css" />
<link rel="stylesheet" href="../static/css/style.css" type="text/css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=RobotoDraft" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="../static/js/jquery-1.11.3.min.js"></script>
<script src="../static/js/imageviewer.js"></script>
<script src="../static/js/bbox_annotator.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/1.11.5/TweenMax.min.js'></script>
<script src='https://kit.fontawesome.com/a076d05399.js'></script>

<style>
  /* Style the search box */
  #mySearch {
    width: 100%;
    font-size: 15px;
    padding: 5px;
    border: 1px solid #ddd;
  }

  /* Center the loader */
  #loading_icon {
    position: absolute;
    left: 50%;
    top: 30%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 30px solid #f3f3f3;
    border-radius: 50%;
    border-top: 30px solid #001f3f;
    width: 300px;
    height: 300px;
    -webkit-animation: spin 1.5s linear infinite;
    animation: spin 1.5s linear infinite;
  }

  /* Center the loader */
  #loading_statistics {
    position: relative;
    left: 45%;
    top: 30%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 30px solid #f3f3f3;
    border-radius: 50%;
    border-top: 30px solid #001f3f;
    width: 200px;
    height: 200px;
    -webkit-animation: spin 1.5s linear infinite;
    animation: spin 1.5s linear infinite;
  }


  /* Button used to open the chat form - fixed at the bottom of the page */
  .QC_open-button {
    background-color: #555;
    color: white;
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    opacity: 0.8;
    position: fixed;
    bottom: 23px;
    right: 10px;
    width: 230px;
  }

  /* The popup chat - hidden by default */
  .QC_chat-popup {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 8px;
    border: 3px solid #f1f1f1;
    z-index: 9;
  }

  /* Add styles to the form container */
  .QC_form-container {
    max-width: 300px;
    padding: 10px;
    background-color: white;
  }

  /* Full-width textarea */
  .QC_form-container textarea {
    width: 100%;
    padding: 15px;
    margin: 5px 0 22px 0;
    border: none;
    background: #f1f1f1;
    resize: none;
    min-height: 100px;
  }

  /* When the textarea gets focus, do something */
  .QC_form-container textarea:focus {
    background-color: #ddd;
    outline: none;
  }

  /* Set a style for the submit/send button */
  .QC_form-container .btn {
    background-color: #4CAF50;
    color: white;
    padding: 5px 5px;
    border: none;
    cursor: pointer;
    width: 100%;
    margin-bottom: 10px;
    opacity: 0.8;
  }

  /* Add a red background color to the cancel button */
  .QC_form-container .cancel {
    background-color: red;
  }

  /* Add some hover effects to buttons */
  .QC_form-container .btn:hover,
  .QC_open-button:hover {
    opacity: 1;
  }

  .QC_CHAT_IMG {
    float: left;
    max-width: 60px;
    width: 100%;
    margin-right: 20px;
    border-radius: 50%;
    padding: 5px;
  }

  .QC_CHAT_IMG_RIGHT {
    float: right;
    max-width: 60px;
    width: 100%;
    margin-right: 0px;
    border-radius: 50%;
    padding: 5px;
  }


  @-webkit-keyframes spin {
    0% {
      -webkit-transform: rotate(0deg);
    }

    100% {
      -webkit-transform: rotate(360deg);
    }
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<body>
  {% block sidenav %}
  <!-- Side Navigation -->
  <nav class="w3-sidebar w3-bar-block w3-collapse w3-animate-left w3-card" id="mySidebar">
    <a href="/logout" class="w3-bar-item w3-button w3-large" id="mySidebar2">
      <img src="../static/src/logo_horizontal.jpg" width=100%>
    </a>
    <div class='w3-container w3-blue-grey'>
      <p><i class="fa fas fa-hospital w3-margin-right w3-large"></i>{{hospital}}
        <button class="w3-button w3-red w3-hover-grey w3-padding-small w3-small" style='float:right;'
          onclick='window.location.href = "/logout";'>LOG OUT</button>
      </p>
    </div>
    <div>
      <div class="w3-dropdown-click" style='width:40%'>
        <button onclick="SHOW_DATASET()" class="w3-button w3-black w3-round-small">날짜 선택하기</button>
        <div id="DATASET_MENU" class="w3-dropdown-content w3-bar-block w3-border w3-animate-opacity"
          style="overflow-y:scroll;height:400px;">
          {% for dataset in datasetlist %}
          <a href="#" class="w3-bar-item w3-button"
            onclick="SHOW_DATASET();SELECT_DATASET('{{dataset['DATASET_NAME']}}');">{{dataset['DATASET_NAME']}}</a>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="w3-bar w3-black">
      <button class="w3-button" id="UNREAD_TAB" onclick="openTab('UNREAD')">UNREAD</button>
      <button class="w3-button" id="COMMENT_TAB" onclick="openTab('COMMENT')">COMMENT</button>
      <button class="w3-button w3-grey" id="ALL_TAB" onclick="openTab('ALL')">ALL</button>
    </div>

    <input type="text" id="mySearch" onkeyup="searchFilter()" placeholder="Search.." title="Type in a category">

    <div id="Demo1" class="w3-animate-left" , style="height:calc(100% - (100px + 210px));">
      {% for data in datalist %}
      <div
        class="{{data['REVIEW_CHECK']}} {{data['CONFIRM_CHECK']}} {{data['DIALOG']}} ARTICLE_LIST w3-display-container"
        id="{{data['FILENAME'][:-4]}}" text="{{data['FILENAME']}}">
        <a href="javascript:void(0)" class="w3-bar-item w3-button test w3-hover-dark-grey"
          onclick="openImage('{{data['FILENAME']}}')" class="img_name">
          <div class="w3-container" style='padding:0px'>
            <div class="w3-opacity" id="xray"><img src=/database/{{current_dataset}}/{{data['FILENAME']}}
                style='height:65px;width:130px;'>
            </div>
            {% if data['NOTI'] == 'HOSPITAL' %}
            <span class="w3-tag w3-round w3-red w3-border w3-border-white w3-display-bottomright"
              style="margin-bottom:15px">NEW</span>
            {% endif %}
            <div class="w3-opacity" id="xray_exp" style='font-size:12px;margin-top:5px;'>
              <i class='fas fa-copy w3-margin-right w3-text-blue'></i>{{data['FILENAME'][0:14]}}
              <br>
              <i class='far fa-hospital w3-margin-right w3-text-blue'></i>{{data['HOSPITAL']}}
              <br>
              <i class='fas fa-smile w3-margin-right w3-text-blue'></i>{{data['NAME']}}
            </div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
    <div class=center>
      <button class=below_btn onclick="SUMMARY_BUTTON_CONTROL();">STATISTICS
        SUMMARY</button>
    </div>
  </nav>
  {% endblock %}

  <!-- Main Page -->
  <div class="w3-main" id="page">
    <div id="page1" class="w3-container person" style='margin-left:300px;'>
      <div id="loading_icon" style='display:none'></div>
      <canvas id="canvas" width=500 height=500 style='display:none'></canvas>
      <div id="main_input" width=60% style='display:none;overflow-y:scroll;height:250px'>
        <br>
      </div>
      <div id="annotation_data" name="annotation" rows="30" cols="50" style="display:none"></div>
      <div>
        {% block rightnav %}
        <div class="width100">
          <div class="slidecontainer">
            <div id="right_box1" style='text-align:left'>
              <div id="right_box2">
                <button id='PREDICTION_BUTTON'
                  class="w3-button w3-grey w3-hover-grey w3-padding-small">PREDICTION</button>
                <button id='RESET_BUTTON' class="w3-button w3-blue w3-hover-grey w3-padding-small">RESET</button>
              </div>
              <div class=''>
                <div id="right_box4">Brightness</div>
                <div id='brightness' style='padding-left:20px'>
                  <input type="range" step="1" min="0" max="100" class="slider" id="myRange">
                </div>
              </div>
              <div class=''>
                <div id="right_box4">Contrast</div>
                <div id='contrast' style='padding-left:20px'>
                  <input type="range" step="1" min="0" max="100" class="slider" id="contraRange">
                </div>
              </div>
              <div id="right_box6">
                <div class=text_left id="prdiction">Prediction</div>
                <div class="text_left f_gray">TMJ RIGHT<b id=TMJ_LEFT_SCORE></b></div>
                <div class="w3-grey">
                  <div id="GA_bar" class="w3-container w3-green w3-center" style="width:100%;height:4px;"></div>
                </div>
                <div class="text_left f_gray">TMJ LEFT<b id=TMJ_RIGHT_SCORE></b></div>
                <div class="w3-grey">
                  <div id="GA_bar" class="w3-container w3-green w3-center" style="width:100%;height:4px;"></div>
                </div>
                <div class="text_left f_gray">OSTEOPOROSIS<b id=OSTEOPOROSIS_SCORE></b></div>
                <div class="w3-grey">
                  <div id="GA_bar" class="w3-container w3-green w3-center" style="width:100%;height:4px;"></div>
                </div>
              </div>
              <br>
              <div id="right_box7" style='text-align:center'>
                <span style="color:black;padding:2px;display:inline-block;">예측 이상소견</span>
              </div>
              <div style="height:calc(100% - 500px);overflow-y:scroll;width:100%;text-align:left;padding:10px;">
                <table id="disease_list" class="w3-table-all w3-text-black">
                </table>
              </div>
              <button class="QC_open-button w3-padding-small w3-blue" style="font-size:16px;" onclick="openChat();">판독
                문의하기</button>
            </div>
          </div>
        </div>
        {% endblock %}
      </div>
    </div>
  </div>

  <!-- Modal INSERT IMAGE -->
  <div id="id01" class="w3-modal" style="z-index:5">
    <div class="w3-modal-content w3-animate-zoom">
      <div class="w3-container w3-padding w3-blue-grey">
        <span onclick="document.getElementById('id01').style.display='none'"
          class="w3-button w3-blue-grey w3-right w3-xxlarge"><i class="fa fa-remove"></i></span>
        <h2 class="w3-blue-grey">Insert New Image</h2>
      </div>
      <div class="w3-panel">
        <label style="border:0px solid red;">Image Lists</label>
        <form id="FILE_FORM" method="post" enctype="multipart/form-data" action="" style="border:0px solid red;">
          <input type="file" class="w3-input w3-border w3-margin-bottom" id="FILE_TAG" name="FILE_TAG"
            style="border:5px solid blue;" multiple>
          <br>
        </form>
        <div class="w3-section" style="border:0px solid red;">
          <a class="w3-button w3-blue-grey" onclick="document.getElementById('id01').style.display='none'">Cancel
             <i class="fa fa-remove"></i></a>
          <a class="w3-button w3-light-grey w3-right"
            onclick="uploadFile();document.getElementById('id01').style.display='none'">Select  <i
              class="fa fa-paper-plane"></i></a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Inquiry Box -->
  <div class="QC_chat-popup w3-white" id="QC_chatform">
    <form class="QC_form-container">
      <h3>판독결과 문의하기</h3>
      <p>
        <input class="w3-check" type="checkbox" value="판독 결과가 이상합니다.">
        <label>판독 결과가 이상합니다.</label>
      </p>
      <p>
        <input class="w3-check" type="checkbox" value="상세 판독 결과를 요청드립니다.">
        <label>상세 판독 결과를 요청드립니다.</label>
      </p>

      <label for="msg"><b></b></label>
      <textarea id='QC_inquire_text' placeholder="필요한 경우 상세내용을 남겨주세요." name="msg" required></textarea>

      <button type="button" class="btn" onclick="sendInquire();">Send</button>
      <button type="button" class="btn cancel" onclick="closeInquire();">Close</button>
    </form>
  </div>

  <!-- Modal Chat Box -->
  <div class="QC_chat-popup w3-white" id="QC_CHATBOX">
    <form class="QC_form-container" style="max-width:500px;width:500px">
      <h2 style='margin-top:0px'>Chat Messages</h2>

      <div id='QC_CHAT_TEXT' style="max-height:500px;overflow-y:scroll;">
      </div>

      <div class='w3-bar'>
        <input class="w3-input w3-border w3-margin-bottom" name="first" type="text" id="QC_chat_text"
          autocomplete="off">
        <button type="button" class="w3-button w3-blue" style="width:50%" onclick="sendChat();">Send</button>
        <button type="button" class="w3-button w3-red" style='float:right;width:50%;'
          onclick="closeChat();">Close</button>
      </div>

    </form>
  </div>

  <!-- Modal STATISTICS SUMMARY -->
  <div id="id03" class="w3-modal" style="z-index:5">
    <div class="w3-modal-content w3-animate-zoom" style="height:70%;">
      <div class="w3-container w3-padding w3-blue-grey">
        <span onclick="document.getElementById('id03').style.display='none'"
          class="w3-button w3-blue-grey w3-right w3-xxlarge"><i class="fa fa-remove"></i></span>
        <h2 class="w3-blue-grey">Statistics Summary</h2>
      </div>
      <div class="w3-panel" style="overflow-y:scroll;height:calc(100% - 110px);">
        <div id="loading_statistics" style='display:none'></div>
        <div id="statistics_contents">
          <h2>Precision Statistics</h2>
          <table id='precision_table' class="w3-table-all w3-hoverable">
            <thead>
              <tr class="w3-black">
                <th class="w3-center">학습날짜</th>
                <th class="w3-center">총 데이터 수</th>
                <th class="w3-center">Average Precision</th>
              </tr>
            </thead>
            <tr>
              <td class="w3-center">2020. 05. 26.</td>
              <td class="w3-center">8000</td>
              <td class="w3-center">80%</td>
            </tr>
          </table>
          <h2>Label Statistics</h2>
          <table id='statistics_table' class="w3-table-all w3-hoverable">
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    var LABEL_DICT = {{ LABEL_DICT| tojson}};
    var LABEL_DICT = JSON.parse(LABEL_DICT);

    var BODY = document.body, HTML = document.documentElement;
    var DEVICEHEIGHT = Math.max(BODY.scrollHeight, BODY.offsetHeight, HTML.clientHeight, HTML.scrollHeight, HTML.offsetHeight);
    var DEVICEWIDTH = Math.max(BODY.scrollWidth, BODY.offsetWidth, HTML.clientWidth, HTML.scrollWidth, HTML.offsetWidth);
    var image_width = DEVICEWIDTH - 650;
    var image_ratio = 0;

    var FILENAME = '';
    var GUIDED_FILENAME = '';
    var DATASET = '{{current_dataset}}';
    var TAB_STATUS = 'ALL';

    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var point_array;

    var canvasOffset = $("#canvas").offset();
    var offsetX = canvasOffset.left;
    var offsetY = canvasOffset.top;

    var brightness = 100;
    var contrast = 100;

    var img = new Image();

    // LOADING ICON
    function loadingStart() {
      $('#loading_icon').show(200);
      $('#canvas').hide(200);
      //$('#main_img').hide(200);
      //$('#main_input').hide(200);
    }

    function showPage() {
      $('#loading_icon').hide(200);
      $('#canvas').show(200);
      //$('#main_img').show(200);
      //$('#main_input').show(200);
    }

    // Chat Enter시 Submit 방지
    $(document).on("keypress", 'form', function (e) {
      if (e.target.className.indexOf("allowEnter") == -1) {
        var code = e.keyCode || e.which;
        if (code == 13) {
          e.preventDefault();
          return false;
        }
      }
    });
    var inputChat = document.getElementById("QC_chat_text");
    inputChat.addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        sendChat();
      }
    });

    // IMAGE LABELER BLOCK
    var annotator;
    var annotator_stop;
    $(document).ready(function () {
      annotator = new BBoxAnnotator({
        url: "../static/img/Z0001.jpg",
        input_method: "select",
        labels: LABEL_DICT,
        onchange: function (entries) {

        },
        width: DEVICEWIDTH - 650,
        height: (DEVICEWIDTH - 650) / 1.9
      });

      $("#Demo1").click(function (e) {
        annotator.clear_all();
      })
    });

    $('#CONFIRM_BUTTON').click(function () {
      $('#main_img').hide(200);
      $('#main_input').hide(200);
      generatePacket('LABEL', 'CONFIRM_CHECK', 'CONFIRM');
      $('.CURRENT').addClass('CONFIRM');
      $('.CURRENT').addClass('READ');
      $('.CURRENT').removeClass('UNCONFIRM');
      $('.CURRENT').removeClass('CURRENT');
      openTab(TAB_STATUS);
      if (TAB_STATUS == 'UNCONFIRM') {
        if ($('.UNCONFIRM').length != 0) {
          setTimeout(function () {
            openImage($('.UNCONFIRM')[0].id + '.jpg');
          }, 300);
        }
        else {
          window.location.href = "/service";
        }
      }
    });

    $('#DELETE_BUTTON').click(function () {
      var delete_check = confirm("정말로 삭제하시겠습니까?");
      if (delete_check == true) {
        $('#main_img').hide(200);
        $('#main_input').hide(200);
        generatePacket('LABEL', 'CONFIRM_CHECK', 'DELETE');
        $('.CURRENT').addClass('DELETE');
        $('.CURRENT').addClass('READ');
        $('.CURRENT').removeClass('UNCONFIRM');
        $('.CURRENT').removeClass('CURRENT');
        openTab(TAB_STATUS);
      }
    });

    var count = 0;

    function TRAINING_BUTTON_CONTROL() {
      alert('데모에서는 지원하지 않는 기능입니다.');
    }

    function PROGRESSING_BUTTON_CONTROL() {
      generatePacket('TRAINING_STATUS', '', '');
    }

    if ('{{training_status}}' == 'STOP') {
      $('#TRAINING_BUTTON').css('display', '');
      $('#PROGRESSING_BUTTON').css('display', 'none');
    }
    else {
      $('#TRAINING_BUTTON').css('display', 'none');
      $('#PROGRESSING_BUTTON').css('display', '');
    }

    function SUMMARY_BUTTON_CONTROL() {
      document.getElementById('id03').style.display = 'block';
      $('#loading_statistics').show(200);
      $('#statistics_contents').hide(200);
      generatePacket('STATISTICS_DEMO', '', '');
    }

    function TMJ_LEFT_BUTTON_CONTROL(signal) {
      if (signal == 'NORMAL') {
        $('#TMJ_LEFT_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#TMJ_LEFT_NORMAL_BUTTON').attr("class", "w3-button w3-black w3-hover-black w3-padding-small");
      }
      if (signal == 'ABNORMAL') {
        $('#TMJ_LEFT_ABNORMAL_BUTTON').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
        $('#TMJ_LEFT_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
      if (signal == 'NONE') {
        $('#TMJ_LEFT_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#TMJ_LEFT_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
    }

    function TMJ_RIGHT_BUTTON_CONTROL(signal) {
      if (signal == 'NORMAL') {
        $('#TMJ_RIGHT_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#TMJ_RIGHT_NORMAL_BUTTON').attr("class", "w3-button w3-black w3-hover-black w3-padding-small");
      }
      if (signal == 'ABNORMAL') {
        $('#TMJ_RIGHT_ABNORMAL_BUTTON').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
        $('#TMJ_RIGHT_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
      if (signal == 'NONE') {
        $('#TMJ_RIGHT_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#TMJ_RIGHT_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
    }

    function OSTEOPOROSIS_BUTTON_CONTROL(signal) {
      if (signal == 'NORMAL') {
        $('#OSTEOPOROSIS_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#OSTEOPOROSIS_NORMAL_BUTTON').attr("class", "w3-button w3-black w3-hover-black w3-padding-small");
      }
      if (signal == 'ABNORMAL') {
        $('#OSTEOPOROSIS_ABNORMAL_BUTTON').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
        $('#OSTEOPOROSIS_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
      if (signal == 'NONE') {
        $('#OSTEOPOROSIS_ABNORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#OSTEOPOROSIS_NORMAL_BUTTON').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
      }
    }

    function LABEL_ONOFF_CONTROL(signal) {
      if (signal == 'ON') {
        $('#labeled_button').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
        $('#normal_button').attr("class", "w3-button w3-grey w3-hover-black w3-padding-small");
        $('#unlabeled_img').css('display', 'none');
        $('#main_img').css('display', '');
      }
      else {
        $('#labeled_button').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        $('#normal_button').attr("class", "w3-button w3-black w3-hover-black w3-padding-small");
        $('#unlabeled_img').css('display', '');
        $('#main_img').css('display', 'none');
      }
    }

    function DRAW_IMAGE() {
      canvas.width = img.width * image_ratio;
      canvas.height = img.height * image_ratio;
      ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
      ctx.filter = 'brightness(' + brightness + '%' + ') ' + 'contrast(' + contrast + '%' + ')';
      ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
      point_array.forEach(function (rect, index) {
        pointing_label(canvas, ctx, img, rect.left + rect.width / 2, rect.top + rect.height / 2, rect.label);
      });
    }

    //BUTTON CONTROL BLOCK
    function BUTTON_CONROL() {
      //DISEASE LABELING
      $('#TMJ_LEFT_NORMAL_BUTTON').click(function () {
        TMJ_LEFT_BUTTON_CONTROL('NORMAL');
        generatePacket('LABEL', 'TMJ_LEFT', 0);
      });
      $('#TMJ_LEFT_ABNORMAL_BUTTON').click(function () {
        TMJ_LEFT_BUTTON_CONTROL('ABNORMAL');
        generatePacket('LABEL', 'TMJ_LEFT', 1);
      });

      $('#TMJ_RIGHT_NORMAL_BUTTON').click(function () {
        TMJ_RIGHT_BUTTON_CONTROL('NORMAL');
        generatePacket('LABEL', 'TMJ_RIGHT', 0);
      });
      $('#TMJ_RIGHT_ABNORMAL_BUTTON').click(function () {
        TMJ_RIGHT_BUTTON_CONTROL('ABNORMAL');
        generatePacket('LABEL', 'TMJ_RIGHT', 1);
      });

      $('#OSTEOPOROSIS_NORMAL_BUTTON').click(function () {
        OSTEOPOROSIS_BUTTON_CONTROL('NORMAL');
        generatePacket('LABEL', 'OSTEOPOROSIS', 0);
      });
      $('#OSTEOPOROSIS_ABNORMAL_BUTTON').click(function () {
        OSTEOPOROSIS_BUTTON_CONTROL('ABNORMAL');
        generatePacket('LABEL', 'OSTEOPOROSIS', 1);
      });

      //PREDICTION RESET BUTTON
      $('#PREDICTION_BUTTON').click(function () {
        function execute1() {
          return new Promise(function (resolve) {
            loadingStart();
            $('#PREDICTION_BUTTON').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
            resolve(1);
          })
        }
        async function execute() {
          result = await execute1();
          generatePacket('PREDICTION', '', '');
        }
        execute();
      });
      $('#RESET_BUTTON').click(function () {
        ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
        ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
        $('#disease_list').html('');
        $('#PREDICTION_BUTTON').attr("class", "w3-button w3-grey w3-hover-red w3-padding-small");
        setTimeout(function () {
          generatePacket('LABEL', 'PREDICTION_CHECK', 'NO_PREDICT');
        }, 300);
      });

      //BRIGHTNESS CONTROL
      $('#brightness input').on("input", function () {
        brightness = this.value * 2;
        DRAW_IMAGE();
        /*
        canvas.width = img.width * image_ratio;
        canvas.height = img.height * image_ratio;
        ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
        ctx.filter = 'brightness(' + this.value * 2 + '%' + ')';
        ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
        */
        //var img = $('#brightness img');
        //TweenMax.set('#main_img', { '-webkit-filter': 'brightness(' + this.value * 2 + '%' + ')' });
      });

      //CONTRAST CONTROL
      $('#contrast input').on("input", function () {
        contrast = this.value * 2;
        DRAW_IMAGE();
        /*
        canvas.width = img.width * image_ratio;
        canvas.height = img.height * image_ratio;
        ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
        ctx.filter = 'contrast(' + this.value * 2 + '%' + ')';
        ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
        */
        //var img = $('#contrast img');
        //TweenMax.set('#main_img', { '-webkit-filter': 'contrast(' + this.value * 2 + '%' + ')' });
      });

      // SET INITIAL BRIGHTNESS CONTRAST
      $('#brightness input').val(50);
      $('#brightness input').trigger("mouseover");
      $('#contrast input').val(50);
      $('#contrast input').trigger("mouseover");

      var tableRows = document.getElementsByClassName('disease_label');
      for (var i = 0; i < tableRows.length; i += 1) {
        tableRows[i].addEventListener('mouseover', function (e) {
          label_count = $(this).attr('name');
          pointing_label(canvas, ctx, img, rect.left + rect.width / 2, rect.top + rect.height / 2, rect.label);
        });
      }
    }

    BUTTON_CONROL();

    function openImage(FILENAME_CURRENT) {

      FILENAME = FILENAME_CURRENT;
      actual_image_width(FILENAME);

      img.onload = function () {
        canvas.width = img.width * image_ratio;
        canvas.height = img.height * image_ratio;
        ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
        ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
      }
      img.src = "/database/" + DATASET + "/" + FILENAME;
      $('#disease_list').html('');

      $('.CURRENT').addClass('READ');
      $('.CURRENT').removeClass('CURRENT');
      $('#' + FILENAME.substring(0, FILENAME.length - 4).replace('.', '\\.')).addClass('CURRENT');

      function execute1() {
        return new Promise(function (resolve) {
          loadingStart();
          resolve(1);
        })
      }
      async function execute() {
        result = await execute1();
        generatePacket('TARGET', '', '');
      }
      execute();
    }

    function pointing_label(canvas, ctx, img, pointX, pointY, label_text) {
      mouseX = pointX;
      mouseY = pointY;
      conf_font = "15px Georgia";
      ctx.fillStyle = "white";
      arrow_length = 10;
      bg_width = 3;
      arrow_thickness = 2;
      left_padding = 15;

      if (mouseY < 100) {
        if (mouseX < 600) {
          ctx.beginPath();
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX, mouseY + arrow_length);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX + arrow_length, mouseY);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX + arrow_length * 2, mouseY + arrow_length * 2);
          ctx.lineWidth = arrow_thickness;
          ctx.strokeStyle = "white";
          ctx.stroke();

          ctx.lineWidth = bg_width;
          ctx.font = conf_font;
          //ctx.strokeText(label_text, mouseX + arrow_length * 2, mouseY + arrow_length * 2 + 5);
          ctx.fillText(label_text, mouseX + arrow_length * 2, mouseY + arrow_length * 2 + 5);
        } else {
          ctx.beginPath();
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX, mouseY + arrow_length);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX - arrow_length, mouseY);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX - arrow_length * 2, mouseY + arrow_length * 2);
          ctx.lineWidth = arrow_thickness;
          ctx.strokeStyle = "white";
          ctx.stroke();

          ctx.lineWidth = bg_width;
          ctx.font = conf_font;
          //ctx.strokeText(label_text, mouseX - left_padding * (label_text.length + 1.5), mouseY + arrow_length * 2 + 5);
          ctx.fillText(label_text, mouseX - left_padding * (label_text.length + 1.5), mouseY + arrow_length * 2 + 5);
        }
      } else {
        if (mouseX < 600) {
          ctx.beginPath();
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX, mouseY - arrow_length);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX + arrow_length, mouseY);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX + arrow_length * 2, mouseY - arrow_length * 2);
          ctx.lineWidth = arrow_thickness;
          ctx.strokeStyle = "white";
          ctx.stroke();

          ctx.lineWidth = bg_width;
          ctx.font = conf_font;
          //ctx.strokeText(label_text, mouseX + arrow_length * 2, mouseY - arrow_length * 2 + 5);
          ctx.fillText(label_text, mouseX + arrow_length * 2, mouseY - arrow_length * 2 + 5);
        }
        else {
          ctx.beginPath();
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX, mouseY - arrow_length);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX - arrow_length, mouseY);
          ctx.moveTo(mouseX, mouseY);
          ctx.lineTo(mouseX - arrow_length * 2, mouseY - arrow_length * 2);
          ctx.lineWidth = arrow_thickness;
          ctx.strokeStyle = "white";
          ctx.stroke();

          ctx.lineWidth = bg_width;
          ctx.font = conf_font;
          //ctx.strokeText(label_text, mouseX - left_padding * (label_text.length + 1.5), mouseY - arrow_length * 2 + 5);
          ctx.fillText(label_text, mouseX - left_padding * (label_text.length + 1.5), mouseY - arrow_length * 2 + 5);
        }
      }
    }

    function sendCompleteLabeling() {
      var parameter = { 'ORDER': 'DB_INFO', 'PARAMETER': 'DB_STATUS', 'SETVALUE': 'COMPLETE', 'DATASET': DATASET };
      sendToServer(parameter);
      window.location.href = "/service";
    }

    function openTab(tabName) {

      if (tabName == 'COMMENT') {
        $('.DELETE').hide(200);
        $('.NOCOMMENT').hide(200);
        $('.COMMENT').show(200);
        $('#COMMENT_TAB').addClass('w3-grey');
        $('#UNREAD_TAB').removeClass('w3-grey');
        $('#ALL_TAB').removeClass('w3-grey');
        TAB_STATUS = 'COMMENT';
      }
      if (tabName == 'UNREAD') {
        $('.DELETE').hide(200);
        $('.READ').hide(200);
        $('.UNREAD').show(200);
        $('#COMMENT_TAB').removeClass('w3-grey');
        $('#UNREAD_TAB').addClass('w3-grey');
        $('#ALL_TAB').removeClass('w3-grey');
        TAB_STATUS = 'UNREAD';
      }
      if (tabName == 'ALL') {
        $('.DELETE').show(200);
        $('.NOCOMMENT').show(200);
        $('.READ').show(200);
        $('#COMMENT_TAB').removeClass('w3-grey');
        $('#UNREAD_TAB').removeClass('w3-grey');
        $('#ALL_TAB').addClass('w3-grey');
        TAB_STATUS = 'ALL';
      }
      searchFilter();
    }

    function searchFilter() {
      input = document.getElementById("mySearch");
      filter = input.value.toUpperCase();
      demo_tag = document.getElementById("Demo1");

      if (TAB_STATUS == 'CONFIRM') {
        div_tag = $('.CONFIRM')
        for (var i = 0; i < div_tag.length; i++) {
          if (div_tag[i].id.toUpperCase().indexOf(filter) > -1) {
            div_tag[i].style.display = "";
          } else {
            div_tag[i].style.display = "none";
          }
        }
      }
      if (TAB_STATUS == 'UNCONFIRM') {
        div_tag = $('.UNCONFIRM')
        for (var i = 0; i < div_tag.length; i++) {
          if (div_tag[i].id.toUpperCase().indexOf(filter) > -1) {
            div_tag[i].style.display = "";
          } else {
            div_tag[i].style.display = "none";
          }
        }
      }
      if (TAB_STATUS == 'ALL') {
        div_tag = $('.CONFIRM, .UNCONFIRM')
        for (var i = 0; i < div_tag.length; i++) {
          if (div_tag[i].id.toUpperCase().indexOf(filter) > -1) {
            div_tag[i].style.display = "";
          } else {
            div_tag[i].style.display = "none";
          }
        }
      }
    }

    function actual_image_width(FILENAME) {
      var dimension, image;
      image = new Image();
      image.src = "/database/" + DATASET + "/" + FILENAME;
      image.onload = function () {
        dimension = {
          width: image.naturalWidth,
          height: image.naturalHeight
        };
        image_ratio = image_width / dimension.width;
      };
    }

    function sendToServer(packet) {
      return new Promise(function (resolve, reject) {
        $.ajax({
          dataType: "JSON",
          url: "/_JSON",
          contentType: "application/json",
          data: JSON.stringify(packet),
          type: 'POST',
          async: true,
          success: function (result) {
            if (packet['ORDER'] == 'REFLASH') {
              result = JSON.parse(result);
              $('#QC_CHAT_TEXT').html('<div class="w3-container w3-dark-grey w3-card-2 w3-margin-bottom" style="padding:5px 5px"><img src="../static/img/avatar_g2.jpg" alt="Avatar" class="QC_CHAT_IMG_RIGHT" style="width:100%;"><p style="margin-top: 0px;margin-right: 80px;"><b>MANAGER</b></p><p style="margin-top: 0px;margin-bottom:0px;margin-right: 80px;">안녕하세요. 판독 관련 문의사항을 남겨주시면 조속히 답변드리겠습니다.</p><span class="time-left"></span></div>');
              $.each(result['DIALOG'], function (index, value) {
                if (value[0] == 'MANAGER') {
                  $('#QC_CHAT_TEXT').append('<div class="w3-container w3-dark-grey w3-card-2 w3-margin-bottom" style="padding:5px 5px"><img src="../static/img/avatar_g2.jpg" alt="Avatar" class="QC_CHAT_IMG_RIGHT" style="width:100%;"><p style="margin-top: 0px;margin-right: 80px;"><b>MANAGER</b></p><p style="margin-top: 0px;margin-bottom:0px;margin-right: 80px;">' + value[1] + '</p><span class="time-left">' + value[2] + '</span></div>');
                } else {
                  $('#QC_CHAT_TEXT').append('<div class="w3-container w3-grey w3-card-2 w3-margin-bottom" style="padding:5px 5px"><img src="../static/img/bandmember.jpg" alt="Avatar" class="QC_CHAT_IMG" style="width:100%;"><p style="margin-top: 0px;margin-left: 80px;"><b>' + value[0] + '</b></p><p style="margin-top: 0px;margin-bottom:0px;margin-left: 80px;">' + value[1] + '</p><span style="float:right">' + value[2] + '</span></div>');
                }
              });
              $('#QC_CHAT_TEXT').scrollTop($('#QC_CHAT_TEXT')[0].scrollHeight);
            }
            if (packet['ORDER'] == 'TARGET') {
              result = JSON.parse(result);
              generatePacket('PREDICTION', '', '');
              $('#PREDICTION_BUTTON').attr("class", "w3-button w3-red w3-hover-red w3-padding-small");
              if (result['TMJ_LEFT'] == '') {
                TMJ_LEFT_BUTTON_CONTROL('NONE');
              } else if (parseInt(result['TMJ_LEFT']) > 0.5) {
                TMJ_LEFT_BUTTON_CONTROL('ABNORMAL');
              } else {
                TMJ_LEFT_BUTTON_CONTROL('NORMAL');
              }
              if (result['TMJ_RIGHT'] == '') {
                TMJ_RIGHT_BUTTON_CONTROL('NONE');
              } else if (parseInt(result['TMJ_RIGHT']) > 0.5) {
                TMJ_RIGHT_BUTTON_CONTROL('ABNORMAL');
              } else {
                TMJ_RIGHT_BUTTON_CONTROL('NORMAL');
              }
              if (result['OSTEOPOROSIS'] == '') {
                OSTEOPOROSIS_BUTTON_CONTROL('NONE');
              } else if (parseInt(result['OSTEOPOROSIS']) > 0.5) {
                OSTEOPOROSIS_BUTTON_CONTROL('ABNORMAL');
              } else {
                OSTEOPOROSIS_BUTTON_CONTROL('NORMAL');
              }
              if (result['CONFIRM_CHECK'] == 'CONFIRM') {
                $('#CONFIRM_BUTTON').attr("class", "w3-button w3-black w3-hover-black");
              } else {
                $('#CONFIRM_BUTTON').attr("class", "w3-button w3-grey w3-hover-black");
              }
            }
            if (packet['ORDER'] == 'PREDICTION') {
              loadPrediction(result);
            }
            if (packet['ORDER'] == 'START_TRAINING') {
              alert(result);
            }
            if (packet['ORDER'] == 'TRAINING_STATUS') {
              alert(result);
            }
            if (packet['ORDER'] == 'STATISTICS_DEMO') {
              $('#loading_statistics').hide(200);
              $('#statistics_contents').show(200);
              LABEL_RANK = result['LABEL_RANK']
              $("#statistics_table").html('<thead><tr class="w3-black"><th class="w3-center">LABEL 항목</th><th class="w3-center">LABEL 수</th></tr></thead>');
              for (var i = 0; i < LABEL_RANK.length; i++) {
                $("#statistics_table").append('<tr><td class="w3-center">' + LABEL_RANK[i][0] + '</td><td class="w3-center">' + LABEL_RANK[i][1] + '</td></tr>');
              }
              PRECISION_DATA = result['PRECISION_DATA']
              $("#precision_table").html('<thead><tr class="w3-black"><th class="w3-center">학습날짜</th><th class="w3-center">총 데이터 수</th><th class="w3-center">Average Precision</th></tr></thead>');
              for (var i = 0; i < PRECISION_DATA.length; i++) {
                $("#precision_table").append('<tr><td class="w3-center">' + PRECISION_DATA[i][0] + '</td><td class="w3-center">' + PRECISION_DATA[i][1] + '</td><td class="w3-center">' + PRECISION_DATA[i][2] + '</td></tr>');
              }
            }
            resolve(1);
          }
        });
      });
    }

    function loadPrediction(result) {
      $('#disease_list').html('');
      point_array = []
      function execute1() {
        return new Promise(function (resolve) {
          result.forEach(function (each_label, index) {
            var rect = {
              left: parseInt(each_label.left * image_ratio),
              top: parseInt(each_label.top * image_ratio),
              width: parseInt(each_label.width * image_ratio),
              height: parseInt(each_label.height * image_ratio)
            };
            rect.label = each_label.label;
            pointing_label(canvas, ctx, img, rect.left + rect.width / 2, rect.top + rect.height / 2, rect.label);
            point_array.push(rect);
            $('#disease_list').append('<tr class="w3-hover-red disease_label" name=' + index + '><td>' + rect.label + '</td></tr>');
          });
          resolve(1);
        })
      }
      async function execute() {
        result = await execute1();
        var tableRows = document.getElementsByClassName('disease_label');
        for (var i = 0; i < tableRows.length; i += 1) {
          tableRows[i].addEventListener('mouseover', function (e) {
            label_count = $(this).attr('name');
            rect = point_array[label_count];
            ctx.fillStyle = "red";
            ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
            ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
            pointing_label(canvas, ctx, img, rect.left + rect.width / 2, rect.top + rect.height / 2, rect.label);
          });
        }
        document.getElementById('disease_list').addEventListener('mouseout', function (e) {
          ctx.fillStyle = "black";
          ctx.clearRect(0, 0, img.width * image_ratio, img.height * image_ratio);
          ctx.drawImage(img, 0, 0, img.width * image_ratio, img.height * image_ratio);
          point_array.forEach(function (rect, index) {
            pointing_label(canvas, ctx, img, rect.left + rect.width / 2, rect.top + rect.height / 2, rect.label);
          });
        });
        showPage();
      }
      execute();
    }

    function generatePacket(ORDER, PARAMETER, SETVALUE) {
      var parameter = {};
      parameter['DATASET'] = DATASET;
      parameter['ORDER'] = ORDER;
      parameter['FILENAME'] = FILENAME;
      parameter['PARAMETER'] = PARAMETER;
      parameter['SETVALUE'] = SETVALUE;
      parameter['ID'] = '{{hospital}}';
      sendToServer(parameter);
    }

    function SHOW_DATASET() {
      var x = document.getElementById("DATASET_MENU");
      if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
      } else {
        x.className = x.className.replace(" w3-show", "");
      }
    }

    function SELECT_DATASET(DATASET_NAME) {
      window.location.href = "/service/" + DATASET_NAME;
    }

    openTab(TAB_STATUS);

    function openInquire() {
      $('#QC_chatform').show(200);
      //document.getElementById("QC_chatform").style.display = "block";
    }

    function sendInquire() {
      var FEEDBACK = '';
      var INQUIRE = '';
      $.each($("input:checked"), function (index, value) {
        FEEDBACK = FEEDBACK + value.value;
      });
      INQUIRE = $('#QC_inquire_text').val();
      generatePacket('LABEL', 'DIALOG', INQUIRE);
      $('#QC_inquire_text').val('');
      $('#QC_chatform').hide(200);
    }

    function closeInquire() {
      $('#QC_chatform').hide(200);
    }

    function openChat() {
      if (FILENAME == '') {
        alert('이미지 선택 후 문의해주세요.');
      }
      else {
        $('#QC_CHATBOX').show(200);
        updateChat();
      }
    }

    function sendChat() {
      var DIALOG = '';
      DIALOG = $('#QC_chat_text').val();
      generatePacket('LABEL', 'DIALOG', DIALOG);
      addChat(DIALOG);
      $('#QC_chat_text').val('');
    }

    function updateChat() {
      generatePacket('REFLASH', 'DIALOG', '');
    }

    function addChat(DIALOG) {
      let today = new Date();
      $('#QC_CHAT_TEXT').append('<div class="w3-container w3-grey w3-card-2 w3-margin-bottom" style="padding:5px 5px;"><img src="../static/img/bandmember.jpg" alt="Avatar" class="QC_CHAT_IMG" style="width:100%;"><p style="margin-top: 0px;margin-left: 80px;"><b>' + '{{hospital}}' + '</b></p><p style="margin-top: 0px;margin-bottom:0px;margin-left: 80px;">' + DIALOG + '</p><span style="float:right">' + today.getFullYear() + '/' + addZeros(today.getMonth(), 2) + '/' + addZeros(today.getDate(), 2) + ' ' + addZeros(today.getHours(), 2) + ':' + addZeros(today.getMinutes(), 2) + ':' + addZeros(today.getSeconds(), 2) + '</span></div>');
      $('#QC_CHAT_TEXT').scrollTop($('#QC_CHAT_TEXT')[0].scrollHeight);
    }

    function closeChat() {
      $('#QC_CHATBOX').hide(200);
    }

    function addZeros(num, digit) { // 자릿수 맞춰주기
      var zero = '';
      num = num.toString();
      if (num.length < digit) {
        for (i = 0; i < digit - num.length; i++) {
          zero += '0';
        }
      }
      return zero + num;
    }

  </script>

</body>

</html>